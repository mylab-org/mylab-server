generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
}

model conferences {
  id                  BigInt      @id @default(autoincrement())
  name_ko             String
  name_en             String?
  category            String?
  location            String?
  address             String?
  link                String?
  submission_deadline DateTime?   @db.Timestamptz(6)
  start_at            DateTime?   @db.Timestamptz(6)
  end_at              DateTime?   @db.Timestamptz(6)
  schedules           schedules[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model device_tokens {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  token      String
  platform   String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([user_id, token])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model invite_codes {
  id           BigInt    @id @default(autoincrement())
  lab_id       BigInt
  code         String    @unique @db.VarChar(20)
  max_uses     Int?
  current_uses Int       @default(0)
  expires_at   DateTime? @db.Timestamptz(6)
  is_active    Boolean   @default(true)
  created_by   BigInt
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  users        users     @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  labs         labs      @relation(fields: [lab_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([lab_id], map: "idx_invite_codes_lab_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model has constraints using non-default deferring rules and requires additional setup for migrations. Visit https://pris.ly/d/constraint-deferring for more info.
model lab_members {
  id                    BigInt                  @id @default(autoincrement())
  user_id               BigInt
  lab_id                BigInt
  role                  String                  @default("MEMBER")
  joined_at             DateTime                @default(now()) @db.Timestamptz(6)
  left_at               DateTime?               @db.Timestamptz(6)
  labs                  labs                    @relation(fields: [lab_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                 users                   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  paper_members         paper_members[]
  papers                papers[]
  schedule_participants schedule_participants[]

  @@unique([user_id, lab_id], map: "uq_lab_members_active_user_lab")
  @@unique([id, lab_id], map: "uq_lab_members_id_lab")
  @@index([lab_id], map: "idx_lab_members_lab_id")
  @@index([lab_id, left_at], map: "idx_lab_members_lab_id_left_at")
}

model labs {
  id               BigInt             @id @default(autoincrement())
  name             String
  school_name      String
  department_name  String
  professor_id     BigInt
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  invite_codes     invite_codes[]
  lab_members      lab_members[]
  users            users              @relation(fields: [professor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  meeting_routines meeting_routines[]
  schedules        schedules[]

  @@index([professor_id], map: "idx_labs_professor_id")
  @@index([school_name, department_name], map: "idx_labs_school_department")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model meeting_routines {
  id            BigInt          @id @default(autoincrement())
  lab_id        BigInt
  day_of_week   Int
  start_time    DateTime        @db.Time(6)
  end_time      DateTime?       @db.Time(6)
  location      String?
  is_active     Boolean         @default(true)
  labs          labs            @relation(fields: [lab_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  meeting_skips meeting_skips[]

  @@index([lab_id], map: "idx_meeting_routines_lab_id")
}

model meeting_skips {
  id               BigInt           @id @default(autoincrement())
  routine_id       BigInt
  skip_date        DateTime         @db.Date
  reason           String?
  notified_at      DateTime?        @db.Timestamptz(6)
  created_by       BigInt
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  users            users            @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  meeting_routines meeting_routines @relation(fields: [routine_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([routine_id, skip_date])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model notifications {
  id             BigInt   @id @default(autoincrement())
  user_id        BigInt
  type           String
  title          String
  body           String?
  reference_id   BigInt?
  reference_type String?
  is_read        Boolean  @default(false)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  users          users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id, created_at], map: "idx_notifications_user_created_at")
  @@index([user_id, is_read], map: "idx_notifications_user_is_read")
}

model paper_members {
  paper_id      BigInt
  lab_id        BigInt
  lab_member_id BigInt
  role          String?
  lab_members   lab_members @relation(fields: [lab_member_id, lab_id], references: [id, lab_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pm_member_lab")
  papers        papers      @relation(fields: [paper_id, lab_id], references: [id, lab_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_pm_paper_lab")

  @@id([paper_id, lab_member_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model papers {
  id                    BigInt          @id @default(autoincrement())
  schedule_id           BigInt
  lab_id                BigInt
  title                 String
  lead_author_member_id BigInt?
  status                String          @default("IDEA")
  created_at            DateTime        @default(now()) @db.Timestamptz(6)
  paper_members         paper_members[]
  lab_members           lab_members?    @relation(fields: [lead_author_member_id, lab_id], references: [id, lab_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_paper_lead_author_lab")
  schedules             schedules       @relation(fields: [schedule_id, lab_id], references: [id, lab_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_paper_schedule_lab")

  @@unique([id, lab_id], map: "uq_papers_id_lab")
  @@index([schedule_id], map: "idx_papers_schedule_id")
}

model schedule_participants {
  schedule_id   BigInt
  lab_id        BigInt
  lab_member_id BigInt
  lab_members   lab_members @relation(fields: [lab_member_id, lab_id], references: [id, lab_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_sp_member_lab")
  schedules     schedules   @relation(fields: [schedule_id, lab_id], references: [id, lab_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_sp_schedule_lab")

  @@id([schedule_id, lab_member_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model schedules {
  id                                BigInt                  @id @default(autoincrement())
  lab_id                            BigInt
  type                              String
  title                             String
  start_at                          DateTime                @db.Timestamptz(6)
  end_at                            DateTime?               @db.Timestamptz(6)
  location                          String?
  memo                              String?
  is_all_members                    Boolean                 @default(true)
  created_by                        BigInt
  updated_by                        BigInt?
  created_at                        DateTime                @default(now()) @db.Timestamptz(6)
  updated_at                        DateTime                @default(now()) @db.Timestamptz(6)
  submission_deadline               DateTime?               @db.Timestamptz(6)
  conference_id                     BigInt?
  papers                            papers[]
  schedule_participants             schedule_participants[]
  conferences                       conferences?            @relation(fields: [conference_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_schedules_created_byTousers users                   @relation("schedules_created_byTousers", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  labs                              labs                    @relation(fields: [lab_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_schedules_updated_byTousers users?                  @relation("schedules_updated_byTousers", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([id, lab_id], map: "uq_schedules_id_lab")
  @@index([lab_id, created_at], map: "idx_schedules_lab_id_created_at")
  @@index([lab_id, start_at], map: "idx_schedules_lab_id_start_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  id                                    BigInt          @id @default(autoincrement())
  username                              String          @unique
  phone                                 String          @unique
  password                              String
  name                                  String
  degree                                String?         @default("BACHELOR")
  professor_email                       String?         @unique
  professor_status                      String          @default("NONE")
  created_at                            DateTime        @default(now()) @db.Timestamptz(6)
  updated_at                            DateTime        @default(now()) @db.Timestamptz(6)
  device_tokens                         device_tokens[]
  invite_codes                          invite_codes[]
  lab_members                           lab_members[]
  labs                                  labs[]
  meeting_skips                         meeting_skips[]
  notifications                         notifications[]
  schedules_schedules_created_byTousers schedules[]     @relation("schedules_created_byTousers")
  schedules_schedules_updated_byTousers schedules[]     @relation("schedules_updated_byTousers")
}
